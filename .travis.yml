matrix:
  include:
  - language: node_js
    node_js:
    - '10'
    cache:
      directories:
      - node_modules
    install:
    - rm -rf node_modules/*/.git/
    - npm install -q --no-color --no-progress
    before_script:
    - curl -L https://codeclimate.com/downloads/test-reporter/test-reporter-latest-linux-amd64
      > ./cc-test-reporter
    - chmod +x ./cc-test-reporter
    - "./cc-test-reporter before-build"
    script:
    - npm run test -- --coverage --watchAll=false
    after_script:
    - "./cc-test-reporter after-build --exit-code $TRAVIS_TEST_RESULT"
  - dist: trusty
    stage: build and deploy docker image
    services:
    - docker
    if: tag IS present
    env:
    - COMMIT=${TRAVIS_COMMIT::8}
    - REPO=okhalid/eop
    before_install:
    - wget -qO- https://toolbelt.heroku.com/install.sh | sh
    - echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" --password-stdin
    - echo "$HEROKU_API_KEY" | docker login -u "$HEROKU_USER" --password-stdin registry.heroku.com
    script:
    - docker build -f heroku/Dockerfile -t $REPO:$COMMIT .
    - docker tag $REPO:$COMMIT $REPO:latest
    - docker tag $REPO:$COMMIT $REPO:$TRAVIS_TAG
    - docker tag $REPO:$COMMIT $REPO:$TRAVIS_TAG
    - docker tag $REPO:$COMMIT registry.heroku.com/$HEROKU_APP_NAME/web
    - docker push $REPO
    - docker push registry.heroku.com/$HEROKU_APP_NAME/web
    - heroku container:release web --app $HEROKU_APP_NAME
notifications:
  email: false
deploy:
  provider: heroku
  api_key:
    secure: qVNytmTlv1J+VuIcj7hru/3bXX4COoNt8NPvaMlRdZFYvcs+x9l7RV67iv1hOvE1qoiuDN5Gsfn/RI8RKKVDnAM82qfWaRh/FBdhomGeneUVs1Ote5+XXjAVfLiRSlL2GL3KRgog3IN6914xo3nWFRrkeAB2YvZZ0QgvtPm1cS8W1TRVB+0ndcpgsJTdBEYZkStJtXb8nxxrBGC0pJr8NSiaXnC0xOt6+9QvOCVKABd7T9sNXUQlyW/saooMYAl0H+bIC+qz12mjEFWlRnRFPM9HyzExTdTVXZZQ6p5ZGTR4lUHFZYVlwx2MNCsZZQfZ8d9QwY/kxxLHApu0LZC0Mv7zcRGQ6L+M4YoVMQjHDWM1olxF31Ust47ilLb3Zahq6zes13hZV1JlPguPLr7SDQthckCxYG0EpQwhUTPpS53tJ6TmC9LqnHBDzKeRQa4XYcHkg4YmSGJXdvKsTUrelXE9iFmR6TQNSWBW1cmhak0huKQnKz+F7pTMqYntthrFJOhkDZUkeMmEmmZeVDQOcT10fSU4lSGk5xlHUAxDIqlYev5mHxrp2rBXETayFldVAOfxC/Gt4HsqXWuezLg4ubqz/xnRcuFzIFF1NykOrgqJ0HE6ClFEOgoTAkqKrgFxcpp9vlY0wvARw6NFu6NLg8iBqqRIWStMKqd4OAS4mvA=
  app: elevation-of-privilege
  on:
    repo: Mich-b/elevation-of-privilege
  skip_cleanup: true
